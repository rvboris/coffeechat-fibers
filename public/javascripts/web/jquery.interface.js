(function(a,b,c,d){function g(){return e.init(this)}"use strict";var e={},f;e.mainEvents=function(){a("#channels").on("click","button.channel",e.tab.activate),a("#channels").on("click","button.remove",e.tab.remove),a("#loading").fadeOut("fast",function(){a("#channels").fadeIn(),a("#channels-content").fadeIn()});var d=a("html").height(),f=a("#channel-list").height(),g=a("#channel-list").height();a(b).resize(function(c){if(c.target!==b)return;var h=a("#channels-content section .scrollableArea").filter(":visible"),i=h.parent().parent().attr("id"),j=310,k=17,l=53;a(".scrollableArea").css("height",a(".chat:last").height()-parseInt(a("scrollableArea").css("padding-bottom"))+"px"),a("#channel-list").css("height")!="auto"&&a("#channel-list").css("height",f+a("html").height()-d+"px"),a("aside.sidebar").css("height")!="auto"&&a("aside.sidebar").css("height",g-l+a("html").height()-d+"px"),a("aside.sidebar").each(function(b,c){c=a(c);if(c.css("left")!="auto")if(c.is(":visible")===!0){var d=c.css("left");c.css("left",c.parent().find(".chat").width()+k+"px"),parseInt(c.parent().find(".chat").css("right"))>=c.width()+k&&e.tab.switching&&c.css("left",d)}else c.css("left",c.parent().find(".chat").width()+k-c.width()+"px")});if(e.sidebar.resizing||e.channels.resizing)return;e.tab.autoWidth(),h.parent().innerWidth()<=j&&(a.jStorage.get("#"+i+"-sidebar-show")==null||a.jStorage.get("#"+i+"-sidebar-show")===!1)?e.sidebar.hide("#"+i,!1,function(){h.parent().innerWidth()<=j&&a.jStorage.get("channel-list")===null|a.jStorage.get("channel-list")===!1&&e.channels.hide()}):h.parent().innerWidth()-a("#"+i).find("aside.sidebar").innerWidth()-e.sidebar.separatorWidth>j&&(a.jStorage.get("#"+i+"-sidebar-show")==null||a.jStorage.get("#"+i+"-sidebar-show")===!0)&&e.sidebar.show("#"+i,!1,function(){h.parent().innerWidth()-a("#channel-list").outerWidth()+k+10>j&&(a.jStorage.get("channel-list")==null||a.jStorage.get("channel-list")===!0)&&e.channels.show()}),h.prop({scrollTop:h.prop("scrollHeight")})}),a("section.account h1").accordion({items:"section.account form.clearfix"}),a("section.help h1").accordion({items:"section.help div.clearfix"}),a("section.help .helpscroll li").accordion({items:"section.help p"}),a().scroller({scrollableArea:a("section.help div.helpscroll .scrollableArea"),spotUp:a("section.help div.helpscroll .scrollingHotSpotUp"),spotDown:a("section.help div.helpscroll .scrollingHotSpotDown"),mouseArea:a("section.help div.helpscroll")}),a().scroller({scrollableArea:a("section.help div.rulesscroll .scrollableArea"),spotUp:a("section.help div.rulesscroll .scrollingHotSpotUp"),spotDown:a("section.help div.rulesscroll .scrollingHotSpotDown"),mouseArea:a("section.help div.rulesscroll")}),a("section.help button.close, #bottom #help").on("click",function(){e.layers.toogle("help")}),a(c).on("contextmenu",function(){return!1}),a("form").attr("novalidate","novalidate")},e.userpic={init:function(){a("#userpic").uploadify({swf:"/flash/uploadify.swf",checkExisting:!1,auto:!0,cancelImage:!1,buttonText:"Загрузить",fileTypeExts:"*.jpg;*.gif;*.png",fileTypeDesc:"Изображения (.JPG, .GIF, .PNG)",fileSizeLimit:10,width:"90",height:"25",onUploadStart:e.userpic.onUploadStart,onUploadSuccess:e.userpic.onUploadSuccess,onUploadError:e.userpic.onUploadError,onSelect:e.userpic.onSelect,onSelectError:e.userpic.onSelectError})},onUploadStart:function(){a("#userpic").uploadifySettings("buttonText","Загрузка...")},onUploadSuccess:function(b,c,d){d&&(c=JSON.parse(c),c.error?(a.jGrowl(c.error,{header:"Ошибка"}),a("#userpic").uploadifySettings("buttonText","Загрузить")):(a("img.userpic").attr("src","/userpics/"+c.pic),a.fn.sys().options.currentUser.pic=c.pic,a("#userpic").uploadifySettings("buttonText","Загружено"),setTimeout(function(){a("#userpic").uploadifySettings("buttonText","Загрузить")},3e3)))},onUploadError:function(){return a.jGrowl("Неизвестная ошибка",{header:"Ошибка"}),!1},onSelect:function(){a("#userpic").uploadifySettings("uploader","/user/"+encodeURIComponent(d.enc(a.fn.sys().options.currentUser.id,a.fn.sys().options.serverKey))+"/pic")},onSelectError:function(b,c){switch(c){case SWFUpload.QUEUE_ERROR.FILE_EXCEEDS_SIZE_LIMIT:a.jGrowl("Размер файла не должен превышать 10КБ (60х60)",{header:"Ошибка"});break;case SWFUpload.QUEUE_ERROR.ZERO_BYTE_FILE:a.jGrowl("Файл пуст",{header:"Ошибка"});break;case SWFUpload.QUEUE_ERROR.INVALID_FILETYPE:a.jGrowl("Недопустимый формат файла",{header:"Ошибка"});break;default:a.jGrowl("Неизвестная ошибка",{header:"Ошибка"})}return!1}},e.account=function(){a("#top").on("click","#user #account",function(){a.fn.sys().options.currentUser.pic?a("img.userpic").attr("src","/userpics/"+a.fn.sys().options.currentUser.pic):a("img.userpic").attr("src","/images/web/userpic2.png"),a('section.account input[name="user[name]"]').val(a.fn.sys().options.currentUser.name),a.fn.sys().options.currentUser.email&&a('section.account input[name="user[email]"]').val(a.fn.sys().options.currentUser.email),a('section.account input[value="1"]').prop("checked")&&a("section.account span.male").trigger("click"),a('section.account input[value="2"]').prop("checked")&&a("section.account span.female").trigger("click"),a.fn.sys().options.currentUser.gender!="N"&&(a.fn.sys().options.currentUser.gender==="M"?a("section.account span.male").trigger("click"):a.fn.sys().options.currentUser.gender==="W"&&a("section.account span.female").trigger("click")),a("section.account form.audio-settings span.switch.checked").trigger("click"),a("section.account form.audio-settings input[type=checkbox]").prop("checked",!1),a.fn.sys().options.currentUser.settings.audio.whenAway&&a("section.account form.audio-settings span.when-away").trigger("click"),a.fn.sys().options.currentUser.settings.audio.whenUnavailable&&a("section.account form.audio-settings span.when-unavailable").trigger("click"),a.fn.sys().options.currentUser.settings.audio.onMessage&&a("section.account form.audio-settings span.on-message").trigger("click"),a.fn.sys().options.currentUser.settings.audio.onPrivate&&a("section.account form.audio-settings span.on-private").trigger("click"),a.fn.sys().options.currentUser.settings.audio.onMention&&a("section.account form.audio-settings span.on-mention").trigger("click"),a.fn.sys().options.currentUser.settings.audio.onEnter&&a("section.account form.audio-settings span.on-enter").trigger("click"),a.fn.sys().options.currentUser.settings.audio.onExit&&a("section.account form.audio-settings span.on-exit").trigger("click"),a("section.account form.interface-settings span.switch.checked").trigger("click"),a("section.account form.interface-settings input[type=checkbox]").prop("checked",!1),a.fn.sys().options.currentUser.settings["interface"].flashTabOnMessage&&a("section.account form.interface-settings span.flashTabOnMessage").trigger("click"),a.fn.sys().options.currentUser.settings["interface"].flashTabOnMention&&a("section.account form.interface-settings span.flashTabOnMention").trigger("click"),a.fn.sys().options.currentUser.settings["interface"].chatNotifications&&a("section.account form.interface-settings span.chatNotifications").trigger("click"),e.layers.toogle("account")}),a("section.account span.male").on("click",function(){if(!a('section.account input[value="1"]').prop("checked")){a("section.account span.female").removeClass("checked"),a(this).addClass("checked"),a('section.account input[value="2"]').prop("checked",!1),a('section.account input[value="1"]').prop("checked",!0);try{yaCounter6276298.hit("/user/account/male",null,null,{user:a.fn.sys().options.currentUser.name})}catch(b){}}else{a(this).removeClass("checked"),a('section.account input[value="1"]').prop("checked",!1);try{yaCounter6276298.hit("/user/account/neutral",null,null,{user:a.fn.sys().options.currentUser.name})}catch(b){}}}),a("section.account span.female").on("click",function(){if(!a('section.account input[value="2"]').prop("checked")){a("section.account span.male").removeClass("checked"),a(this).addClass("checked"),a('section.account input[value="1"]').prop("checked",!1),a('section.account input[value="2"]').prop("checked",!0);try{yaCounter6276298.hit("/user/account/female",null,null,{user:a.fn.sys().options.currentUser.name})}catch(b){}}else{a(this).removeClass("checked"),a('section.account input[value="2"]').prop("checked",!1);try{yaCounter6276298.hit("/user/account/neutral",null,null,{user:a.fn.sys().options.currentUser.name})}catch(b){}}}),a("section.account form.audio-settings span.switch, section.account form.interface-settings span.switch").on("click",function(){a(this).prev().prop("checked")?(a(this).removeClass("checked").html("off"),a(this).prev().prop("checked",!1)):(a(this).addClass("checked").html("on"),a(this).prev().prop("checked",!0))}),a("section.account button.cancel").on("click",function(){return e.layers.toogle("account"),!1});var b={message:"Сохранение...",css:{border:"none",background:"transparent",height:"25px","line-height":"25px",color:"#C4B1C4","font-size":"1.1em"},overlayCSS:{opacity:.6,backgroundColor:"#4A324A"}};a("section.account form.account").submit(function(){return a("section.account").block(b),a.post("/user/account",a("section.account form.account input").serialize()).success(function(b){if(b.error)return a.jGrowl(b.error,{header:"Ошибка"});a.jGrowl("Сохранение завершено",{header:"Уведомление"}),e.layers.toogle("account",function(){try{yaCounter6276298.hit("/user/account",null,null,{user:a.fn.sys().options.currentUser.name})}catch(b){}})}).error(function(){a.jGrowl("Не удалось сохранить данные аккаунта",{header:"Ошибка"})}).complete(function(){a("section.account").unblock()}),!1}),a("section.account form.audio-settings, section.account form.interface-settings").submit(function(){a("section.account").block(b);if(a(this).hasClass("audio-settings")){var c=a("section.account form.audio-settings input[type=checkbox]").serializeObject();c.section="audio"}else a(this).hasClass("interface-settings")&&(c=a("section.account form.interface-settings input[type=checkbox]").serializeObject(),c.section="interface");return a.post("/user/settings",c).success(function(b){if(b.error)return a.jGrowl(b.error,{header:"Ошибка"});a.jGrowl("Сохранение завершено",{header:"Уведомление"}),a.fn.sys().options.updateUser(a.extend({},a.fn.sys().options.currentUser,{settings:b})),e.layers.toogle("account",function(){try{yaCounter6276298.hit("/user/account",null,null,{user:a.fn.sys().options.currentUser.name})}catch(b){}})}).error(function(){a.jGrowl("Не удалось сохранить настройки",{header:"Ошибка"})}).complete(function(){a("section.account").unblock()}),!1}),a("#top #login #forgot, section.forgot button.cancel").on("click",function(){return e.layers.toogle("forgot",null),!1}),a("section.forgot form.forgot").submit(function(){return a("section.forgot").block(a.extend(!0,{},b,{message:"Отправка..."})),a.post("/user/forgot",a("section.forgot form.forgot input").serialize()).success(function(b){if(b.error)return a.jGrowl(b.error,{header:"Ошибка"});a.jGrowl("На ваш email отправлены сведения для восстановления пароля",{header:"Уведомление"}),e.layers.toogle("forgot",function(){try{yaCounter6276298.hit("/user/forgot",null,null,null)}catch(a){}})}).error(function(){a.jGrowl("Не удалось отправить данные для восстановления пароля",{header:"Ошибка"})}).complete(function(){a("section.forgot").unblock()}),!1})},e.smiles=function(){a("#channels-content div#smiles img").on("click",function(){a("#message").val(a("#message").val()+" [:"+a(this).attr("src").split(/\./)[0].split("/")[3]+":] ").focus(),a("#bottom button#smile").trigger("click")}).jail({event:"mouseover",selector:"#bottom button#smile"}),a("#bottom button#smile").on("click",function(){if(a("#container").css("opacity")==="0")return;return a("#channels-content div#smiles").is(":visible")?a("#channels-content div#smiles").hide("slide",{direction:"down"},"fast",function(){a("#bottom button#smile").removeClass("pressed")}):a("#channels-content div#smiles").show("slide",{direction:"down"},"fast",function(){a("#bottom button#smile").addClass("pressed")}),!1})},e.statuses=function(){a("#top").on("click","#user button.switch",function(){var b=a(this).parent();return b.hasClass("closed")?(a("#user div.statuses").fadeIn("fast",function(){b.removeClass("closed"),b.addClass("opened")}),a(this).text("◄")):b.hasClass("opened")&&(a("#user div.statuses").fadeOut("fast",function(){b.removeClass("opened"),b.addClass("closed")}),a(this).text("►")),!1}),a("body").on("click","#user div.statuses button",function(){a.fn.sys().status.change(a(this).attr("id")),a.fn.sys().options.updateUser(a.extend({},a.fn.sys().options.currentUser,{overrideStatus:a(this).attr("id")!="online"})),a("#user button.switch").trigger("click")})},e.tab={switching:!1,remove:function(){e.tab.unreadCounter(a(this).parent());var b=a(this).parent().find(".channel"),c=b.attr("id"),d=c.substr(8,c.length);a.fn.sys().fayeClient.unsubscribe("/channel/"+d),a.fn.sys().fayeClient.unsubscribe("/channel/"+d+"/users"),b.data("private")&&a.fn.sys().fayeClient.unsubscribe("/channel/"+d+"/private"),a("#"+c+"-content").hide("fade","fast",function(){a(this).remove()}),a(this).parent().hide("puff",{direction:"up"},"fast",function(){a(this).remove();var b=a.fn.sys().subscriptions.indexOf(d);b>0&&(a.fn.sys().subscriptions.splice(b,1),a.fn.sys().options.updateSubscriptions(a.fn.sys().subscriptions)),a("#channels li.current").length===0&&a("#channels li").not(".arrow").length>0&&a("#channels li").not(".arrow").last().addClass("current").find("button.channel").trigger("click"),e.tab.autoWidth()})},activate:function(){var b=a("#"+a(this).attr("id")+"-content"),d=b.find(".scrollableArea"),f=this,g=310,h=17;if(b.filter(":visible").size()>0)return;e.tab.switching=!0,a("#channels-content section").fadeOut("fast"),b.fadeIn("fast",function(){a("aside.sidebar").each(function(b,c){c=a(c),c.css("left")!="auto"&&(c.is(":visible")===!0?(c.css("left",c.parent().find(".chat").width()+h+"px"),c.css("opacity","1")):(c.css("opacity","0"),c.css("left",c.parent().find(".chat").width()+h-c.width()+"px")))}),!e.sidebar.resizing&&!e.channels.resizing&&(b.find(".chat").innerWidth()<=g?e.sidebar.hide("#"+b.attr("id"),!1):b.find(".chat").innerWidth()-a("#"+b.attr("id")).find("aside.sidebar").innerWidth()-e.sidebar.separatorWidth>g&&e.sidebar.show("#"+b.attr("id"),!1)),e.tab.switching=!1}),a("#channels li").not(".arrow").removeClass("current"),a(f).parent().addClass("current"),d.prop({scrollTop:d.prop("scrollHeight")}),a(c).prop("title",a(c).prop("title").replace(/(?:\/\/\s).+$/,"// "+a(f).find("span.name").text())),e.tab.unreadCounter(f),a(f).stop(!0,!0).next().stop(!0,!0)},autoWidth:function(){var b=a("#channels li").not(".arrow"),c=[],d=[],f=e.tab.checkWidth(),g=0,h;b.each(function(b,e){g+=a(e).outerWidth(),g>=f.containerWidth&&a(e).is(":visible")&&d.push(b),g<f.containerWidth&&a(e).not(":visible")&&c.push(b)});if(d.length>0)for(h=0;h<=d.length;h++)(function(c){a(b[d[c]]).fadeOut("fast",function(){c===d.length-1&&e.tab.updateArrow()})})(h);if(c.length>0)for(h=0;h<=c.length;h++)(function(d){a(b[c[d]]).fadeIn("fast",function(){d===c.length-1&&e.tab.updateArrow()})})(h)},checkWidth:function(){var b=a("#channels").innerWidth()-(a("#channels li.arrow").is(":visible")?48:0),c=0;return a("#channels li").not(".arrow").each(function(b,d){c+=a(d).outerWidth()}),{isOut:c>=b,containerWidth:b}},updateArrow:function(){var b=a("#channels li").not(".arrow").not(":visible").length,c=a("#channels li.arrow").is(":visible");a("#channels li.arrow div.counter").text(b.toString()),b===0&&c&&a("#channels li.arrow").fadeOut("fast"),b>=1&&!c&&a("#channels li.arrow").fadeIn("fast",function(){a("#channels li").filter(":visible").not(".arrow").last().find("button.channel").trigger("click")})}},e.sidebar={resizing:!1,paddingWidth:3,separatorWidth:11,hide:function(b,c,d){typeof c=="undefined"&&(c=!0),a(b+" .sidebar").fadeOut("fast",function(){a(b+" .chat").animate({right:e.sidebar.separatorWidth+e.sidebar.paddingWidth+"px"},"fast",function(){a(b).removeClass("use-sidebar"),c&&a.jStorage.set(b+"-sidebar-show",!1),typeof d=="function"&&d()}),a(b+" .separator").animate({right:"1px"},"fast")})},show:function(b,c,d){function f(){var f=a("#channels-content section .scrollableArea").filter(":visible");f.prop({scrollTop:f.prop("scrollHeight")}),a(b).addClass("use-sidebar"),c&&a.jStorage.set(b+"-sidebar-show",!0),e.sidebar.resizing=!1,typeof d=="function"&&d()}typeof c=="undefined"&&(c=!0);if(a(b+" .sidebar").is("visible")){typeof d=="function"&&d();return}a.jStorage.get(b+"-sidebar-size")!=null?(a(b+" .chat").animate({right:parseInt(a.jStorage.get(b+"-sidebar-size"))+e.sidebar.separatorWidth+e.sidebar.paddingWidth*2+"px"},"fast",f),a(b+" .separator").animate({right:parseInt(a.jStorage.get(b+"-sidebar-size"))+e.sidebar.paddingWidth+"px"},"fast",function(){a(b+" .sidebar").fadeIn("fast")})):(a(b+" .chat").animate({right:parseInt(a(b+" .sidebar").css("width"))+e.sidebar.separatorWidth+e.sidebar.paddingWidth*2+"px"},"fast",f),a(b+" .separator").animate({right:parseInt(a(b+" .sidebar").css("width"))+e.sidebar.paddingWidth+"px"},"fast",function(){a(b+" .sidebar").fadeIn("fast")}))}},e.user={formatGender:function(a){return"<span class='gender "+(a.gender==="M"?"male":"female")+"'>"+e.user.getGenderLiteral(a.gender)+"</span>"},getGenderLiteral:function(a){return a!="N"?a==="M"?"♂":"♀":""}},e.message={formatSendTo:function(b){var c="→ (";for(var d in b)c+="<button class='name"+(b[d]===a.fn.sys().options.currentUser.name?" me":"")+"'>"+b[d]+(d==b.length-1?"</button>":"</button>, ");return c+=") "}},e.channels={resizing:!1,padding:10,space:5,borders:2,show:function(b){if(parseInt(a("#channel-list").css("left"))>=0){typeof b=="function"&&b();return}var c=a("#channels-content > section").filter(":visible").find("aside.sidebar").css("left");a("#channel-list").animate({left:e.channels.padding+"px"},"fast",b),a("#channel-list-holder").animate({left:e.channels.padding+parseInt(a("#channel-list").css("width"))+e.channels.borders+e.channels.space+"px"},"fast"),a("#channels, #channels-content").animate({left:e.channels.padding+parseInt(a("#channel-list").css("width"))+e.channels.borders*2+parseInt(a("#channel-list-holder").css("width"))+e.channels.space*2+"px"},{duration:"fast",step:function(b){c!="auto"&&a("aside.sidebar").css("left",parseInt(c)+e.channels.padding*2+e.channels.space*2-b+"px")},complete:function(){var b=a("#channels-content section .scrollableArea").filter(":visible");b.prop({scrollTop:b.prop("scrollHeight")}),e.tab.autoWidth()}})},hide:function(b){if(parseInt(a("#channel-list").css("left"))<0){if(typeof b=="function")return b();return}var c=a("#channels-content > section").filter(":visible").find("aside.sidebar").css("left");a("#channel-list").animate({left:"-"+parseInt(a("#channel-list").css("width"))+"px"},"fast",b),a("#channel-list-holder").animate({left:"10px"}),a("#channels, #channels-content").animate({left:e.channels.padding+parseInt(a("#channel-list-holder").css("width"))+e.channels.space+e.channels.borders*2+"px"},{duration:"fast",step:function(b){c!="auto"&&a("aside.sidebar").css("left",parseInt(c)+e.channels.borders*2+e.channels.padding+e.channels.space*2+parseInt(a("#channel-list-holder").css("width"))+parseInt(a("#channel-list").css("width"))-b+"px")},complete:function(){e.tab.autoWidth()}})}},e.channel={qtips:{floatParams:{content:{title:{button:!0},text:"Загрузка...",ajax:{type:"POST",dataType:"json"}},show:{ready:!0,delay:0,solo:!0},hide:{fixed:!0,leave:!1,delay:2e3},position:{my:"top center",at:"bottom center"},style:"ui-tooltip-styling"},modalParams:{position:{my:"center",at:"center",target:a(b)},show:{solo:!0,event:!1,delay:50},hide:{event:!1},style:"ui-tooltip-styling"},init:function(a){e.channel.qtips.profile(a),e.channel.qtips.info(a),e.channel.qtips.tabArrow()},info:function(c){a("#channels li").on("mouseup","button#channel-"+c,function(d){if(d.which!=3)return;if(a.fn.sys().options.currentUser.id==="0"||a(this).data("private")||a.fn.sys().actions.popup)return;a(this).removeData("qtip").qtip(a.extend(!0,{},e.channel.qtips.floatParams,{content:{title:{text:'Информация о чате "'+a(this).find("span.name").text()+'"'},text:"Загрузка...",ajax:{url:"/channel/"+encodeURIComponent(c)+"/info",success:function(b){var c='<ul class="channelinfo">';c+='<li><span class="param">Пользователи:</span> <span class="value">'+b.users+"</span></li>",c+='<li><span class="param">Сообщения:</span> <span class="value">'+b.messages+"</span></li>",c+='<li><span class="param">Дата создания:</span> <span class="value">'+a.fn.sys().time.date(a.fn.sys().time.parse(b.date))+"</span></li>",c+="</ul>",this.set("content.text",c)}}},position:{viewport:a(b)},show:{event:!1}})).show()})},profile:function(b){a("#channel-"+b+"-content").on("mouseup","div.message button:not(.me), .sidebar button.name:not(.me)",function(c){if(c.which!=3)return;if(a.fn.sys().options.currentUser.id==="0"||a(this).text()==="$"||a.fn.sys().actions.popup)return;a(this).removeData("qtip").qtip(a.extend(!0,{},e.channel.qtips.floatParams,{content:{title:{text:"Профиль "+a(this).text()},ajax:{url:"/user/"+encodeURIComponent(a(this).text())+"/profile",success:function(b,c){var d='<img src="'+(typeof b.pic=="undefined"?"/images/web/userpic1.png":"/userpics/"+b.pic)+'" width="60" height="60" class="pic" />';d+='<ul class="profile clearfix">',d+='<li class="status"><span class="param">Статус:</span> <span class="value">'+a.fn.sys().status.toStringDisplay(b.status)+"</span></li>",d+='<li class="gender"><span class="param">Пол:</span> <span class="value">'+a.fn.sys().gender.toStringDisplay(b.gender)+"</span></li>",d+='<li class="messages"><span class="param">Сообщений:</span> <span class="value">'+b.messages+"</span></li>",d+='<li class="points"><span class="param">Баллы:</span> <span class="value">'+b.points+"</span></li>",d+='</ul><div class="actions clearfix">',d+='<button class="private'+(b.status==="F"||b.isIgnore?" disabled":"")+'" onclick="$.fn.sys().actions.private.request(\''+b.name+"', '"+b.status+"')\">Приват</button>",d+='<button class="ignore '+(b.isIgnore?"on":"off")+'" onclick="$.fn.sys().actions.ignore(\''+b.name+"', '"+(b.isIgnore?"remove":"add")+"')\">"+(b.isIgnore?"Убрать игнор":"Игнор")+"</button>",d+="</div>",this.set("content.text",d)}}},position:{viewport:a("#channel-"+b+"-content .scrollableArea")},show:{event:!1}})).show()})},tabArrow:function(){a("#channels li.arrow").removeData("qtip").qtip({content:"Последние вкладки были скрыты, освободите место для их отображения",position:{at:"left center",my:"center right"},show:{event:"click mouseenter"},style:"ui-tooltip-tipsy"})}},type:{timeouts:[]}},e.layers={items:[],add:function(a,b,c,d){if(e.layers.items[a])return;e.layers.items[a]={layer:b,callbacks:{show:c,hide:d}}},toogle:function(b,c){if(!e.layers.items[b])return;a(e.layers.items[b].layer).is(":visible")?(e.layers.hide(),a("#container").fadeTo("fast",1),a("#message").focus()):e.layers.hide(function(){e.layers.show(b,c)})},show:function(b,c){a("#container").fadeTo("fast",0),a(e.layers.items[b].layer).fadeIn("fast",function(){typeof e.layers.items[b].callbacks.show=="function"&&e.layers.items[b].callbacks.show(),typeof c=="function"&&c()})},register:function(){e.layers.add("account","section.account",null,null),e.layers.add("forgot","section.forgot",null,null),e.layers.add("help","section.help",function(){a("#bottom #help").addClass("pressed")},function(){a("#bottom #help").removeClass("pressed")})}},g.prototype.tab={add:function(b,d,f,g){if(a("#channel-"+d).length!=0)return;a("#channels li").not(".arrow").removeClass("current"),a("#channels-content section").hide(),a("#channels li.arrow").before("<li class='current'><button class='channel' id='channel-"+d+"'>"+"<span class='name'>"+b+"</span>"+"</button>"+(a("#channels li").not(".arrow").size()>0?"<button class='remove'>x</button>":"")+"</li>"),a("#channels-content").append("<section id='channel-"+d+"-content' class='use-sidebar'>"+"<div class='chat'>"+"<button class='scrollingHotSpotUp'>˄ ˄ ˄</button>"+"<div class='scrollableArea'>"+"<div class='notifications'>"+"<ul class='type'><span>Печатает:</span></ul>"+"</div>"+"</div>"+"<button class='scrollingHotSpotDown'>˅ ˅ ˅</button>"+"</div>"+"<a class='separator'></a>"+"<aside class='sidebar'>"+"<header>Пользователи (<span>0</span>)</header>"+"<button class='scrollingHotSpotUp'>˄ ˄ ˄</button>"+"<ul class='user-list'></ul>"+"<button class='scrollingHotSpotDown'>˅ ˅ ˅</button>"+"<div class='filterBox'>"+"<input type='text' name='userFilter' placeholder='поиск' class='filter' />"+"</div>"+"</aside>"+"<ul class='sendto'><span>→</span></ul>"+"</section>"),a("#channels li button#channel-"+d).data("private",f["private"]),a().scroller({scrollableArea:a("#channel-"+d+"-content .scrollableArea"),spotUp:a("#channel-"+d+"-content .chat .scrollingHotSpotUp"),spotDown:a("#channel-"+d+"-content .chat .scrollingHotSpotDown"),mouseArea:a("#channel-"+d+"-content .chat")}),a().scroller({scrollableArea:a("#channel-"+d+"-content .sidebar ul"),spotUp:a("#channel-"+d+"-content .sidebar .scrollingHotSpotUp"),spotDown:a("#channel-"+d+"-content .sidebar .scrollingHotSpotDown"),mouseArea:a("#channel-"+d+"-content .sidebar")}),a("#channel-"+d+"-content .sidebar input.filter").val(""),a("#channel-"+d+"-content .sidebar input.filter").change(function(){var b=a(this).val().toLowerCase();return b?(a("#channel-"+d+"-content .sidebar ul button.name").filter(function(){return a(this).text().toLowerCase().indexOf(b)<0}).parent().slideUp("fast"),a("#channel-"+d+"-content .sidebar ul button.name").filter(function(){return a(this).text().toLowerCase().indexOf(b)>=0}).parent().slideDown("fast")):a("#channel-"+d+"-content .sidebar li").filter(":hidden").slideDown("fast"),!1}).keyup(function(){a(this).change()}),a("#channel-"+d+"-content").on("click","div.message button:not(.me), .sidebar button.name:not(.me)",function(){if(a.fn.sys().options.currentUser.id==="0"||a(this).text()==="$")return!1;var b=a(this).text(),c=function(){return b===a(this).text()},e=a("#channel-"+d+"-content .sendto li").length;if(a("#channel-"+d+"-content .sendto button.name").filter(c).length>0)return!1;if(e===3)return a.jGrowl("Вы можете обращаться не более чем к 3 пользователям",{header:"Ошибка"});var f=e>0?"<li style='display: none'>":"<li>";f+="<button class='name'>"+b+"</button>",f+="<button class='close'>x</button>",f+="</li>",a("#channel-"+d+"-content .sendto").append(f),e===0?a("#channel-"+d+"-content .sendto").show("slide",{direction:"left"},"fast"):a("#channel-"+d+"-content .sendto li:last-child").show("drop",{direction:"left"},"fast");try{yaCounter6276298.hit("/message/to",null,null,{user:a.fn.sys().options.currentUser.name,to:b})}catch(g){}return!1}),a("#channel-"+d+"-content .sendto").on("click","button.close",function(){a(this).parent().hide("drop",{direction:"left"},"fast",function(){a(this).remove();var b=a("#channel-"+d+"-content");b.find(".sendto li").length===0&&(b.is(":visible")?b.find(".sendto").fadeOut("fast"):b.find(".sendto").css("display","none"))})}),e.channel.qtips.init(d),e.tab.checkWidth().isOut?(e.tab.updateArrow(),typeof g=="function"&&g()):a("#channels li.current").show("puff",{direction:"right"},"fast",function(){a("#channel-"+d+"-content").show("fast",function(){a(c).prop("title",a(c).prop("title").replace(/(?:\/\/\s).+$/,"// "+b)),typeof g=="function"&&g()})})},unreadCounter:function(b){if(a(b).find("span.count").length>0){var d=a(c).prop("title").match(/(?!\()\d+/),e=a(b).find("span.count").text().match(/(?!\()\d+(?!\()/);if(e!=null){try{e=parseInt(e[0])}catch(f){return}if(d!=null){try{d=parseInt(d[0])}catch(f){return}d-e<=0?a(c).prop("title",a(c).prop("title").replace(/^\(\d+\)\s/,"")):a(c).prop("title",a(c).prop("title").replace(/(?!\()\d+/,d-e))}a(b).find("span.count").remove()}}},height:function(b){a("#channel-"+b+"-content .scrollableArea").css("height",a(".chat:last").height()-parseInt(a("scrollableArea").css("padding-bottom"))+"px")},flash:function(b,c){for(var d=0;d<=120;d++)a("button#channel-"+b).effect("highlight",{color:c},500).next().effect("highlight",{color:c},500)}},g.prototype.sidebar={init:function(b,c){e.sidebar.resizing=!0,a(b+" .separator").on("click",function(d){d.preventDefault(),a(b).hasClass("use-sidebar")?e.sidebar.hide(b,!c["private"]):e.sidebar.show(b,!c["private"])}),a.jStorage.get(b+"-sidebar-size")!=null&&a(b+" .sidebar").css("width",a.jStorage.get(b+"-sidebar-size")),a(b+" .sidebar").resizable({handles:"w",minWidth:150,maxWidth:400,resize:function(c,d){a(b+" .separator").css("right",d.size.width+e.sidebar.paddingWidth+"px"),a(b+" .chat").css("right",d.size.width+e.sidebar.separatorWidth+e.sidebar.paddingWidth*2+"px"),e.sidebar.resizing=!0},stop:function(){a(b+" .separator").css("right",a(this).width()+e.sidebar.paddingWidth+"px"),a(b+" .chat").css("right",a(this).width()+e.sidebar.separatorWidth+e.sidebar.paddingWidth*2+"px"),c["private"]||a.jStorage.set(b+"-sidebar-size",a(b+" .sidebar").css("width"));var d=a(this).parent().find(".scrollableArea");d.prop({scrollTop:d.prop("scrollHeight")}),d=a(this).find("ul"),d.prop({scrollTop:d.prop("scrollHeight")}),e.sidebar.resizing=!1}}),a.jStorage.get(b+"-sidebar-show")===null?(a(b).addClass("use-sidebar"),e.sidebar.show(b,!1)):c["private"]||(a.jStorage.get(b+"-sidebar-show")?(a(b).addClass("use-sidebar"),e.sidebar.show(b,!0)):(a(b).removeClass("use-sidebar"),e.sidebar.hide(b,!0)))}},g.prototype.login={hide:function(){a("#login").hide("slide",{direction:"up"},"fast",function(){a("#top").append("<div id='user' style='display: none'>Добро пожаловать <div class='status closed'><span class='name'>"+a.fn.sys().options.currentUser.name+"</span>"+"<span class='icon online'> </span>"+"<button class='switch'>►</button>"+"<div class='statuses'>"+"<button id='online'>"+"<span class='icon'> </span>"+"<span class='status'>На месте</span>"+"</button>"+"<button id='away'>"+"<span class='icon'> </span>"+"<span class='status'>Отошел</span>"+"</button>"+"<button id='unavailable'>"+"<span class='icon'> </span>"+"<span class='status'>Недоступен</span>"+"</button>"+"</div>"+"</div> / "+"<button id='account'>Аккаунт</button> / "+"<button id='logout'>Выйти</button>"+"</div>"),a("#top #user").show("slide",{direction:"down"},"fast")})}},g.prototype.user={connect:function(b,c){if(a("#channel-"+b+"-content .sidebar li button").filter(function(){return a(this).text()===c.name}).length===0){a("#channel-"+b+"-content .sidebar ul").append(e.user.format(c)),a("#channel-"+b+"-content .sidebar header span").text(parseInt(a("#channel-"+b+"-content .sidebar header span").text())+1);if(a.fn.sys().options.currentUser.id!="0"&&a.fn.sys().options.currentUser.ignore.indexOf(c.name)>-1)return;a("#channel-"+b+"-content .sidebar li:last-child").effect("pulsate",{times:2},1e3,function(){a.fn.sys().channel.notify(b,c,'В комнату вошел пользователь <button class="name">'+c.name+"</button>")})}},disconnect:function(c,d){a("#channel-"+c+"-content .sidebar li button").filter(function(){return a(this).text()===d.name}).fadeOut("slow",function(){a(this).parent().remove(),a("#channel-"+c+"-content .sidebar header span").text(parseInt(a("#channel-"+c+"-content .sidebar header span").text())-1)}),a("#channel-"+c+"-content .sendto li button.name").filter(function(){return a(this).text()===d.name}).next().trigger("click"),a("div.qtip").filter(":visible").find("button.yes").data("name")===d.name&&(a(b).qtip("api").hide(),a.fn.sys().actions.popup=!1,a.fn.sys().actions["private"].queue.shift(),a.fn.sys().actions["private"].queue.length>0&&(e.channel.qtips["private"](a.fn.sys().actions["private"].queue[0]),a(b).qtip("api").show())),a.fn.sys().channel.notify(c,d,'Пользователь <button class="name">'+d.name+"</button> вышел из комнаты")},updateGender:function(b,c){var d=a("#channel-"+b+"-content .sidebar li button").filter(function(){return a(this).text()===c.name}).parent(),f=d.find("span.gender");if(f.length>0)if(c.gender!="N"){if(f.text()===e.user.getGenderLiteral(c.gender))return;f.text(e.user.getGenderLiteral(c.gender)),c.gender==="M"?f.removeClass("female").addClass("male"):c.gender==="W"&&f.removeClass("male").addClass("female")}else f.remove();else c.gender!="N"&&d.append(e.user.formatGender(c));a.fn.sys().options.currentUser.id!="0"&&c.name===a.fn.sys().options.currentUser.name&&a.fn.sys().options.updateUser(a.extend({},a.fn.sys().options.currentUser,{gender:c.gender})),a.fn.sys().channel.notify(b,c,'Пользователь <button class="name">'+c.name+"</button> сменил пол")},updateStatus:function(b,c){var d=a("#channel-"+b+"-content .sidebar li button").filter(function(){return a(this).text()==c.name}).parent(),e=d.find("span.status");if(c.status==="O"&&e.hasClass("online"))return;if(c.status==="F"&&e.hasClass("offline"))return;if(c.status==="A"&&e.hasClass("away"))return;if(c.status==="N"&&e.hasClass("unavailable"))return;a.fn.sys().options.currentUser.id!="0"&&c.name===a.fn.sys().options.currentUser.name&&(a("#user div.status > .icon").removeClass(a.fn.sys().status.toString(a.fn.sys().options.currentUser.status)).addClass(a.fn.sys().status.toString(c.status)),a.fn.sys().options.updateUser(a.extend({},a.fn.sys().options.currentUser,{status:c.status}))),e.removeClass("offline online away unavailable").addClass(c.status==="F"?"online":a.fn.sys().status.toString(c.status)).text(c.status),a.fn.sys().channel.notify(b,c,'Пользователь <button class="name">'+c.name+"</button> сменил статус")},format:function(b){return"<li"+(a.fn.sys().options.currentUser.id!="0"&&a.fn.sys().options.currentUser.ignore.indexOf(b.name)>-1?' class="ignore"':"")+">"+'<span class="status '+(b.status==="F"?"online":a.fn.sys().status.toString(b.status))+'"> </span>'+"<button class='name"+(b.name===a.fn.sys().options.currentUser.name?" me":"")+"'>"+b.name+"</button>"+(b.gender!="N"?e.user.formatGender(b):"")+"</li>"},highlightMe:function(){a(".message button.name, .sidebar button.name").filter(function(){return this.innerHTML===a.fn.sys().options.currentUser.name}).addClass("me")},filterIgnore:function(){a(".message button.name, .sidebar button.name").filter(function(){return a.fn.sys().options.currentUser.ignore.indexOf(this.innerHTML)>-1}).parent().addClass("ignore"),a(".message button.name, .sidebar button.name").filter(function(){return a.fn.sys().options.currentUser.ignore.indexOf(this.innerHTML)===-1}).parent().removeClass("ignore");var b=a("#channels-content section .scrollableArea").filter(":visible");b.prop({scrollTop:b.prop("scrollHeight")})}},g.prototype.message={format:function(b){return"<div class='message cleafix'><time>["+a.fn.sys().time.format(a.fn.sys().time.parse(b.time))+"]</time>"+'<button class="name'+(b.name===a.fn.sys().options.currentUser.name?" me":"")+'">'+b.name+"</button>:"+"<p>"+(b.to&&b.to.length>0?e.message.formatSendTo(b.to):"")+a().emoticon(b.text)+"</p>"+"</div>"}},g.prototype.channels={init:function(){if(a.jStorage.get("channel-list.size")!=null){var b=a("#channel-list").width()-parseInt(a.jStorage.get("channel-list.size"));a("#channel-list").css("left",parseInt(a("#channel-list").css("left"))+b),a("#channel-list").css("width",a.jStorage.get("channel-list.size"))}a("#channel-list").resizable({handles:"e",minWidth:150,maxWidth:300,resize:function(b,c){a("#channels, #channels-content").css("left",c.size.width+e.channels.padding+e.channels.borders*2+e.channels.space*2+parseInt(a("#channel-list-holder").css("width"))+"px"),a("#channel-list-holder").css("left",c.size.width+e.channels.padding+e.channels.borders+e.channels.space+"px");var d=a("aside.sidebar").filter(":visible");d.css("left")!="auto"&&d.css("left",d.parent().find(".chat").width()+17+"px"),e.channels.resizing=!0},stop:function(){a("#channels, #channels-content").css("left",a(this).width()+e.channels.padding+e.channels.borders*2+e.channels.space*2+parseInt(a("#channel-list-holder").css("width"))+"px"),a("#channel-list-holder").css("left",a(this).width()+e.channels.padding+e.channels.borders+e.channels.space+"px");var b=a("aside.sidebar").filter(":visible");b.css("left")!="auto"&&b.css("left",b.parent().find(".chat").width()+17+"px"),a.jStorage.set("channel-list.size",a("#channel-list").css("width"));var c=a("#channels-content section .scrollableArea").filter(":visible");c.prop({scrollTop:c.prop("scrollHeight")}),e.channels.resizing=!1}}),a("body").on("click","#channel-list-holder",function(){e.channels.showChannelList(!0)}),a().scroller({scrollableArea:a("#channel-list menu"),spotUp:a("#channel-list .scrollingHotSpotUp"),spotDown:a("#channel-list .scrollingHotSpotDown"),mouseArea:a("#channel-list")}),a("#channel-list input.filter").val(""),a("#channel-list input.filter").change(function(){var b=a(this).val().toLowerCase();return b?(a("#channel-list menu span.name").filter(function(){return a(this).text().toLowerCase().indexOf(b)<0}).parent().parent().slideUp("fast"),a("#channel-list menu span.name").filter(function(){return a(this).text().toLowerCase().indexOf(b)>=0}).parent().parent().slideDown("fast")):a("#channel-list menu li").filter(":hidden").slideDown("fast"),!1}).keyup(function(){a(this).change()})},showChannelList:function(b){parseInt(a("#channel-list").css("left"))<0||!a("#channel-list").is(":visible")?e.channels.show(function(){a("#channel-list menu").prop({scrollTop:0}),b&&a.jStorage.set("channel-list",!0)}):(e.channels.hide(null),b&&a.jStorage.set("channel-list",!1))}},g.prototype.channel={type:{update:function(b,c){var d=function(){return b===a(this).text()},f=a("#channel-"+c+"-content .type li").length;e.channel.type.timeouts[c]||(e.channel.type.timeouts[c]=[]),e.channel.type.timeouts[c][b]&&clearTimeout(e.channel.type.timeouts[c][b]),e.channel.type.timeouts[c][b]=setTimeout(function(){a("#channel-"+c+"-content .type li").filter(d).hide("drop",{direction:"left"},"fast",function(){a(this).remove(),a("#channel-"+c+"-content .type li").length===0&&a("#channel-"+c+"-content .type").fadeOut("fast",function(){a("#channel-"+c+"-content .scrollableArea").prop({scrollTop:a("#channel-"+c+"-content .scrollableArea").prop("scrollHeight")})})})},1500);if(a("#channel-"+c+"-content .type li").filter(d).length>0)return!1;if(f>=2)return!1;var g=(f>0?"<li style='display: none'>":"<li>")+b+"</li>";a("#channel-"+c+"-content .type").append(g),f===0?a("#channel-"+c+"-content .type").show("slide",{direction:"left"},"fast",function(){a("#channel-"+c+"-content .scrollableArea").prop({scrollTop:a("#channel-"+c+"-content .scrollableArea").prop("scrollHeight")})}):a("#channel-"+c+"-content .type li:last-child").show("drop",{direction:"left"},"fast",function(){a("#channel-"+c+"-content .scrollableArea").prop({scrollTop:a("#channel-"+c+"-content .scrollableArea").prop("scrollHeight")})})}},qtips:{"private":function(c){var d='Пользователь "'+c+'" хочет пригласить вас в приват, вы согласны?';d+='<div class="actions yesno clearfix"><button class="yes" data-name="'+c+'" onclick="$.fn.sys().actions.private.yes(\''+c+"')\">Да</button>"+'<button class="no" data-name="'+c+'" onclick="$.fn.sys().actions.private.no(\''+c+"')\">Нет</button>"+"</div>",a(b).qtip(a.extend(!0,{},e.channel.qtips.modalParams,{id:"privateModal",content:{text:d,title:{text:"Приглашение в приват ["+a.fn.sys().time.format(new Date)+"]"}}}))}},format:function(a){return'<li><button data-id="'+a.id+'" data-url="'+a.url+'">'+'<span class="name">'+a.name+'</span> (<span class="count">'+a.count+"</span>)"+"</button>"+"</li>"}},g.prototype.layers={hide:function(b){if(a("#container").css("opacity")==="1"){typeof b=="function"&&b();return}for(var c in e.layers.items){var d=e.layers.items[c];if(!a(d.layer).is(":visible"))continue;a(d.layer).fadeOut("fast",function(){typeof d.callbacks.hide=="function"&&d.callbacks.hide(),typeof b=="function"&&b()})}}},e.init=function(b){a.extend(!0,e,b),e.mainEvents(),e.layers.register(),e.userpic.init(),e.account(),e.smiles(),e.statuses()},a.fn.ufc=function(){return f?f:f=new g}})(jQuery,window,document,GibberishAES)
