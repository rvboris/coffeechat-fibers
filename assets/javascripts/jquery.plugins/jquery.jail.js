(function(a){var b=a(window);a.fn.asynchImageLoader=a.fn.jail=function(c){c=a.extend({timeout:10,effect:!1,speed:400,selector:null,offset:0,event:"load+scroll",callback:jQuery.noop,callbackAfterEachImage:jQuery.noop,placeholder:!1,ignoreHiddenImages:!1},c);var d=this;return a.jail.initialStack=this,this.data("triggerEl",c.selector?a(c.selector):b),c.placeholder!==!1&&d.each(function(){a(this).attr("src",c.placeholder)}),/^load/.test(c.event)?a.asynchImageLoader.later.call(this,c):a.asynchImageLoader.onEvent.call(this,c,d),this},a.asynchImageLoader=a.jail={_purgeStack:function(a){var b=0;for(;;){if(b===a.length)break;a[b].getAttribute("data-href")?b++:a.splice(b,1)}},_loadOnEvent:function(b){var c=a(this),d=b.data.options,e=b.data.images;a.asynchImageLoader._loadImageIfVisible(d,c),c.unbind(d.event,a.asynchImageLoader._loadOnEvent),a.asynchImageLoader._purgeStack(e),!d.callback||(a.asynchImageLoader._purgeStack(a.jail.initialStack),a.asynchImageLoader._launchCallback(a.jail.initialStack,d))},_bufferedEventListener:function(b){var c=b.data.images,d=b.data.options,e=c.data("triggerEl");clearTimeout(c.data("poller")),c.data("poller",setTimeout(function(){c.each(function(){a.asynchImageLoader._loadImageIfVisible(d,this,e)}),a.asynchImageLoader._purgeStack(c),!d.callback||(a.asynchImageLoader._purgeStack(a.jail.initialStack),a.asynchImageLoader._launchCallback(a.jail.initialStack,d))},d.timeout))},onEvent:function(c,d){d=d||this;if(c.event==="scroll"||c.selector){var e=d.data("triggerEl");if(d.length>0){e.bind(c.event,{images:d,options:c},a.asynchImageLoader._bufferedEventListener),(c.event==="scroll"||!c.selector)&&b.resize({images:d,options:c},a.asynchImageLoader._bufferedEventListener);return}!e||e.unbind(c.event,a.asynchImageLoader._bufferedEventListener)}else d.bind(c.event,{options:c,images:d},a.asynchImageLoader._loadOnEvent)},later:function(b){var c=this;b.event==="load"&&c.each(function(){a.asynchImageLoader._loadImageIfVisible(b,this,c.data("triggerEl"))}),a.asynchImageLoader._purgeStack(c),a.asynchImageLoader._launchCallback(c,b),setTimeout(function(){b.event==="load"?c.each(function(){a.asynchImageLoader._loadImage(b,a(this))}):c.each(function(){a.asynchImageLoader._loadImageIfVisible(b,this,c.data("triggerEl"))}),a.asynchImageLoader._purgeStack(c),a.asynchImageLoader._launchCallback(c,b),b.event==="load+scroll"&&(b.event="scroll",a.asynchImageLoader.onEvent(b,c))},b.timeout)},_launchCallback:function(b,c){b.length===0&&!a.jail.isCallback&&(c.callback.call(this,c),a.jail.isCallback=!0)},_loadImageIfVisible:function(c,d,e){var f=a(d),g=/scroll/i.test(c.event)?e:b,h=!0;c.ignoreHiddenImages&&(h=a.jail._isVisibleInOverflownContainer(f,c)&&f.is(":visible")),h&&a.asynchImageLoader._isInTheScreen(g,f,c.offset)&&a.asynchImageLoader._loadImage(c,f)},_isInTheScreen:function(a,b,c){var d=a[0]===window,e=d?{top:0,left:0}:a.offset(),f=e.top+(d?a.scrollTop():0),g=e.left+(d?a.scrollLeft():0),h=g+a.width(),i=f+a.height(),j=b.offset(),k=b.width(),l=b.height();return f-c<=j.top+l&&i+c>=j.top&&g-c<=j.left+k&&h+c>=j.left},_loadImage:function(a,b){b.hide(),b.attr("src",b.attr("data-href")),b.removeAttr("data-href"),a.effect?a.speed?b[a.effect](a.speed):b[a.effect]():b.show(),a.callbackAfterEachImage.call(this,b,a)},_isVisibleInOverflownContainer:function(b,c){var d=b.parent(),e=!0;while(d.get(0).tagName!=="BODY"){if(d.css("overflow")==="hidden"&&!a.jail._isInTheScreen(d,b,c.offset)){e=!1;break}if(d.css("visibility")==="hidden"||b.css("visibility")==="hidden"){e=!1;break}d=d.parent()}return e}}})(jQuery);