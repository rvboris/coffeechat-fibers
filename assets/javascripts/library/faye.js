var Faye=typeof Faye=="object"?Faye:{};typeof window!="undefined"&&(window.Faye=Faye),Faye.extend=function(a,b,c){if(!b)return a;for(var d in b){if(!b.hasOwnProperty(d))continue;if(a.hasOwnProperty(d)&&c===!1)continue;a[d]!==b[d]&&(a[d]=b[d])}return a},Faye.extend(Faye,{VERSION:"0.8.0",BAYEUX_VERSION:"1.0",ID_LENGTH:128,JSONP_CALLBACK:"jsonpcallback",CONNECTION_TYPES:["long-polling","cross-origin-long-polling","callback-polling","websocket","eventsource","in-process"],MANDATORY_CONNECTION_TYPES:["long-polling","callback-polling","in-process"],ENV:function(){return this}(),random:function(a){a=a||this.ID_LENGTH;if(a>32){var b=Math.ceil(a/32),c="";while(b--)c+=this.random(32);return c}var d=Math.pow(2,a)-1,e=d.toString(36).length,c=Math.floor(Math.random()*d).toString(36);while(c.length<e)c="0"+c;return c},copyObject:function(a){var b,c,d;if(a instanceof Array){b=[],c=a.length;while(c--)b[c]=Faye.copyObject(a[c]);return b}if(typeof a=="object"){b={};for(d in a)b[d]=Faye.copyObject(a[d]);return b}return a},commonElement:function(a,b){for(var c=0,d=a.length;c<d;c++)if(this.indexOf(b,a[c])!==-1)return a[c];return null},indexOf:function(a,b){if(a.indexOf)return a.indexOf(b);for(var c=0,d=a.length;c<d;c++)if(a[c]===b)return c;return-1},map:function(a,b,c){if(a.map)return a.map(b,c);var d=[];if(a instanceof Array)for(var e=0,f=a.length;e<f;e++)d.push(b.call(c||null,a[e],e));else for(var g in a){if(!a.hasOwnProperty(g))continue;d.push(b.call(c||null,g,a[g]))}return d},filter:function(a,b,c){var d=[];for(var e=0,f=a.length;e<f;e++)b.call(c||null,a[e],e)&&d.push(a[e]);return d},asyncEach:function(a,b,c,d){var e=a.length,f=-1,g=0,h=!1,i=function(){g-=1,f+=1;if(f===e)return c&&c.call(d);b(a[f],k)},j=function(){if(h)return;h=!0;while(g>0)i();h=!1},k=function(){g+=1,j()};k()},toJSON:function(a){return this.stringify?this.stringify(a,function(a,b){return this[a]instanceof Array?this[a]:b}):JSON.stringify(a)},timestamp:function(){var a=new Date,b=a.getFullYear(),c=a.getMonth()+1,d=a.getDate(),e=a.getHours(),f=a.getMinutes(),g=a.getSeconds(),h=function(a){return a<10?"0"+a:String(a)};return h(b)+"-"+h(c)+"-"+h(d)+" "+h(e)+":"+h(f)+":"+h(g)}}),Faye.Class=function(a,b){typeof a!="function"&&(b=a,a=Object);var c=function(){return this.initialize?this.initialize.apply(this,arguments)||this:this},d=function(){};return d.prototype=a.prototype,c.prototype=new d,Faye.extend(c.prototype,b),c},Faye.Namespace=Faye.Class({initialize:function(){this._d={}},exists:function(a){return this._d.hasOwnProperty(a)},generate:function(){var a=Faye.random();while(this._d.hasOwnProperty(a))a=Faye.random();return this._d[a]=a},release:function(a){delete this._d[a]}}),Faye.Error=Faye.Class({initialize:function(a,b,c){this.code=a,this.params=Array.prototype.slice.call(b),this.message=c},toString:function(){return this.code+":"+this.params.join(",")+":"+this.message}}),Faye.Error.parse=function(a){a=a||"";if(!Faye.Grammar.ERROR.test(a))return new this(null,[],a);var b=a.split(":"),c=parseInt(b[0]),d=b[1].split(","),a=b[2];return new this(c,d,a)},Faye.Error.versionMismatch=function(){return(new this(300,arguments,"Version mismatch")).toString()},Faye.Error.conntypeMismatch=function(){return(new this(301,arguments,"Connection types not supported")).toString()},Faye.Error.extMismatch=function(){return(new this(302,arguments,"Extension mismatch")).toString()},Faye.Error.badRequest=function(){return(new this(400,arguments,"Bad request")).toString()},Faye.Error.clientUnknown=function(){return(new this(401,arguments,"Unknown client")).toString()},Faye.Error.parameterMissing=function(){return(new this(402,arguments,"Missing required parameter")).toString()},Faye.Error.channelForbidden=function(){return(new this(403,arguments,"Forbidden channel")).toString()},Faye.Error.channelUnknown=function(){return(new this(404,arguments,"Unknown channel")).toString()},Faye.Error.channelInvalid=function(){return(new this(405,arguments,"Invalid channel")).toString()},Faye.Error.extUnknown=function(){return(new this(406,arguments,"Unknown extension")).toString()},Faye.Error.publishFailed=function(){return(new this(407,arguments,"Failed to publish")).toString()},Faye.Error.serverError=function(){return(new this(500,arguments,"Internal server error")).toString()},Faye.Deferrable={callback:function(a,b){if(!a)return;if(this._v==="succeeded")return a.apply(b,this._j);this._k=this._k||[],this._k.push([a,b])},timeout:function(a,b){var c=this,d=Faye.ENV.setTimeout(function(){c.setDeferredStatus("failed",b)},a*1e3);this._w=d},errback:function(a,b){if(!a)return;if(this._v==="failed")return a.apply(b,this._j);this._l=this._l||[],this._l.push([a,b])},setDeferredStatus:function(){this._w&&Faye.ENV.clearTimeout(this._w);var a=Array.prototype.slice.call(arguments),b=a.shift(),c;this._v=b,this._j=a,b==="succeeded"?c=this._k:b==="failed"&&(c=this._l);if(!c)return;var d;while(d=c.shift())d[0].apply(d[1],this._j)}},Faye.Publisher={countListeners:function(a){return!this._3||!this._3[a]?0:this._3[a].length},bind:function(a,b,c){this._3=this._3||{};var d=this._3[a]=this._3[a]||[];d.push([b,c])},unbind:function(a,b,c){if(!this._3||!this._3[a])return;if(!b){delete this._3[a];return}var d=this._3[a],e=d.length;while(e--){if(b!==d[e][0])continue;if(c&&d[e][1]!==c)continue;d.splice(e,1)}},trigger:function(){var a=Array.prototype.slice.call(arguments),b=a.shift();if(!this._3||!this._3[b])return;var c=this._3[b],d;for(var e=0,f=c.length;e<f;e++)d=c[e],d[0].apply(d[1],a)}},Faye.Timeouts={addTimeout:function(a,b,c,d){this._5=this._5||{};if(this._5.hasOwnProperty(a))return;var e=this;this._5[a]=Faye.ENV.setTimeout(function(){delete e._5[a],c.call(d)},1e3*b)},removeTimeout:function(a){this._5=this._5||{};var b=this._5[a];if(!b)return;clearTimeout(b),delete this._5[a]}},Faye.Logging={LOG_LEVELS:{error:3,warn:2,info:1,debug:0},logLevel:"error",log:function(a,b){if(!Faye.logger)return;var c=Faye.Logging.LOG_LEVELS;if(c[Faye.Logging.logLevel]>c[b])return;var a=Array.prototype.slice.apply(a),d=" ["+b.toUpperCase()+"] [Faye",e=this.className,f=a.shift().replace(/\?/g,function(){try{return Faye.toJSON(a.shift())}catch(b){return"[Object]"}});for(var g in Faye){if(e)continue;if(typeof Faye[g]!="function")continue;this instanceof Faye[g]&&(e=g)}e&&(d+="."+e),d+="] ",Faye.logger(Faye.timestamp()+d+f)}},function(){for(var a in Faye.Logging.LOG_LEVELS)(function(a,b){Faye.Logging[a]=function(){this.log(arguments,a)}})(a,Faye.Logging.LOG_LEVELS[a])}(),Faye.Grammar={LOWALPHA:/^[a-z]$/,UPALPHA:/^[A-Z]$/,ALPHA:/^([a-z]|[A-Z])$/,DIGIT:/^[0-9]$/,ALPHANUM:/^(([a-z]|[A-Z])|[0-9])$/,MARK:/^(\-|\_|\!|\~|\(|\)|\$|\@)$/,STRING:/^(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*$/,TOKEN:/^(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+$/,INTEGER:/^([0-9])+$/,CHANNEL_SEGMENT:/^(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+$/,CHANNEL_SEGMENTS:/^(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+(\/(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+)*$/,CHANNEL_NAME:/^\/(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+(\/(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+)*$/,WILD_CARD:/^\*{1,2}$/,CHANNEL_PATTERN:/^(\/(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+)*\/\*{1,2}$/,VERSION_ELEMENT:/^(([a-z]|[A-Z])|[0-9])(((([a-z]|[A-Z])|[0-9])|\-|\_))*$/,VERSION:/^([0-9])+(\.(([a-z]|[A-Z])|[0-9])(((([a-z]|[A-Z])|[0-9])|\-|\_))*)*$/,CLIENT_ID:/^((([a-z]|[A-Z])|[0-9]))+$/,ID:/^((([a-z]|[A-Z])|[0-9]))+$/,ERROR_MESSAGE:/^(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*$/,ERROR_ARGS:/^(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*(,(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*)*$/,ERROR_CODE:/^[0-9][0-9][0-9]$/,ERROR:/^([0-9][0-9][0-9]:(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*(,(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*)*:(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*|[0-9][0-9][0-9]::(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*)$/},Faye.Extensible={addExtension:function(a){this._6=this._6||[],this._6.push(a),a.added&&a.added(this)},removeExtension:function(a){if(!this._6)return;var b=this._6.length;while(b--){if(this._6[b]!==a)continue;this._6.splice(b,1),a.removed&&a.removed(this)}},pipeThroughExtensions:function(a,b,c,d){this.debug("Passing through ? extensions: ?",a,b);if(!this._6)return c.call(d,b);var e=this._6.slice(),f=function(b){if(!b)return c.call(d,b);var h=e.shift();if(!h)return c.call(d,b);h[a]?h[a](b,f):f(b)};f(b)}},Faye.extend(Faye.Extensible,Faye.Logging),Faye.Channel=Faye.Class({initialize:function(a){this.id=this.name=a},push:function(a){this.trigger("message",a)},isUnused:function(){return this.countListeners("message")===0}}),Faye.extend(Faye.Channel.prototype,Faye.Publisher),Faye.extend(Faye.Channel,{HANDSHAKE:"/meta/handshake",CONNECT:"/meta/connect",SUBSCRIBE:"/meta/subscribe",UNSUBSCRIBE:"/meta/unsubscribe",DISCONNECT:"/meta/disconnect",META:"meta",SERVICE:"service",expand:function(a){var b=this.parse(a),c=["/**",a],d=b.slice();d[d.length-1]="*",c.push(this.unparse(d));for(var e=1,f=b.length;e<f;e++)d=b.slice(0,e),d.push("**"),c.push(this.unparse(d));return c},isValid:function(a){return Faye.Grammar.CHANNEL_NAME.test(a)||Faye.Grammar.CHANNEL_PATTERN.test(a)},parse:function(a){return this.isValid(a)?a.split("/").slice(1):null},unparse:function(a){return"/"+a.join("/")},isMeta:function(a){var b=this.parse(a);return b?b[0]===this.META:null},isService:function(a){var b=this.parse(a);return b?b[0]===this.SERVICE:null},isSubscribable:function(a){return this.isValid(a)?!this.isMeta(a)&&!this.isService(a):null},Set:Faye.Class({initialize:function(){this._2={}},getKeys:function(){var a=[];for(var b in this._2)a.push(b);return a},remove:function(a){delete this._2[a]},hasSubscription:function(a){return this._2.hasOwnProperty(a)},subscribe:function(a,b,c){if(!b)return;var d;for(var e=0,f=a.length;e<f;e++){d=a[e];var g=this._2[d]=this._2[d]||new Faye.Channel(d);g.bind("message",b,c)}},unsubscribe:function(a,b,c){var d=this._2[a];return d?(d.unbind("message",b,c),d.isUnused()?(this.remove(a),!0):!1):!1},distributeMessage:function(a){var b=Faye.Channel.expand(a.channel);for(var c=0,d=b.length;c<d;c++){var e=this._2[b[c]];e&&e.trigger("message",a.data)}}})}),Faye.Publication=Faye.Class(Faye.Deferrable),Faye.Subscription=Faye.Class({initialize:function(a,b,c,d){this._7=a,this._2=b,this._m=c,this._n=d,this._x=!1},cancel:function(){if(this._x)return;this._7.unsubscribe(this._2,this._m,this._n),this._x=!0},unsubscribe:function(){this.cancel()}}),Faye.extend(Faye.Subscription.prototype,Faye.Deferrable),Faye.Client=Faye.Class({UNCONNECTED:1,CONNECTING:2,CONNECTED:3,DISCONNECTED:4,HANDSHAKE:"handshake",RETRY:"retry",NONE:"none",CONNECTION_TIMEOUT:60,DEFAULT_RETRY:5,DEFAULT_ENDPOINT:"/bayeux",INTERVAL:0,initialize:function(a,b){this.info("New client created for ?",a),this.endpoint=a||this.DEFAULT_ENDPOINT,this._E=Faye.CookieJar&&new Faye.CookieJar,this._y={},this._o=b||{},this._p=[],this.retry=this._o.retry||this.DEFAULT_RETRY,this._z(Faye.MANDATORY_CONNECTION_TYPES),this._1=this.UNCONNECTED,this._2=new Faye.Channel.Set,this._e=0,this._q={},this._8={reconnect:this.RETRY,interval:1e3*(this._o.interval||this.INTERVAL),timeout:1e3*(this._o.timeout||this.CONNECTION_TIMEOUT)},Faye.Event&&Faye.Event.on(Faye.ENV,"beforeunload",function(){Faye.indexOf(this._p,"autodisconnect")<0&&this.disconnect()},this)},disable:function(a){this._p.push(a)},setHeader:function(a,b){this._y[a]=b},getClientId:function(){return this._0},getState:function(){switch(this._1){case this.UNCONNECTED:return"UNCONNECTED";case this.CONNECTING:return"CONNECTING";case this.CONNECTED:return"CONNECTED";case this.DISCONNECTED:return"DISCONNECTED"}},handshake:function(a,b){if(this._8.reconnect===this.NONE)return;if(this._1!==this.UNCONNECTED)return;this._1=this.CONNECTING;var c=this;this.info("Initiating handshake with ?",this.endpoint),this._9({channel:Faye.Channel.HANDSHAKE,version:Faye.BAYEUX_VERSION,supportedConnectionTypes:[this._a.connectionType]},function(e){if(e.successful){this._1=this.CONNECTED,this._0=e.clientId;var h=Faye.filter(e.supportedConnectionTypes,function(a){return Faye.indexOf(this._p,a)<0},this);this._z(h),this.info("Handshake successful: ?",this._0),this.subscribe(this._2.getKeys(),!0),a&&a.call(b)}else this.info("Handshake unsuccessful"),Faye.ENV.setTimeout(function(){c.handshake(a,b)},this._8.interval),this._1=this.UNCONNECTED},this)},connect:function(a,b){if(this._8.reconnect===this.NONE)return;if(this._1===this.DISCONNECTED)return;if(this._1===this.UNCONNECTED)return this.handshake(function(){this.connect(a,b)},this);this.callback(a,b);if(this._1!==this.CONNECTED)return;this.info("Calling deferred actions for ?",this._0),this.setDeferredStatus("succeeded"),this.setDeferredStatus("deferred");if(this._r)return;this._r=!0,this.info("Initiating connection for ?",this._0),this._9({channel:Faye.Channel.CONNECT,clientId:this._0,connectionType:this._a.connectionType},this._A,this)},disconnect:function(){if(this._1!==this.CONNECTED)return;this._1=this.DISCONNECTED,this.info("Disconnecting ?",this._0),this._9({channel:Faye.Channel.DISCONNECT,clientId:this._0},function(a){a.successful&&this._a.close()},this),this.info("Clearing channel listeners for ?",this._0),this._2=new Faye.Channel.Set},subscribe:function(a,b,c){if(a instanceof Array){for(var d=0,e=a.length;d<e;d++)this.subscribe(a[d],b,c);return}var f=new Faye.Subscription(this,a,b,c),g=b===!0,h=this._2.hasSubscription(a);if(!g){this._2.subscribe([a],b,c);if(h)return f.setDeferredStatus("succeeded"),f}return this.connect(function(){this.info("Client ? attempting to subscribe to ?",this._0,a),this._9({channel:Faye.Channel.SUBSCRIBE,clientId:this._0,subscription:a},function(d){if(!d.successful)return f.setDeferredStatus("failed",Faye.Error.parse(d.error)),this._2.unsubscribe(a,b,c);var e=[].concat(d.subscription);this.info("Subscription acknowledged for ? to ?",this._0,e),f.setDeferredStatus("succeeded")},this)},this),f},unsubscribe:function(a,b,c){if(a instanceof Array){for(var d=0,e=a.length;d<e;d++)this.unsubscribe(a[d],b,c);return}var f=this._2.unsubscribe(a,b,c);if(!f)return;this.connect(function(){this.info("Client ? attempting to unsubscribe from ?",this._0,a),this._9({channel:Faye.Channel.UNSUBSCRIBE,clientId:this._0,subscription:a},function(a){if(!a.successful)return;var b=[].concat(a.subscription);this.info("Unsubscription acknowledged for ? from ?",this._0,b)},this)},this)},publish:function(a,b){var c=new Faye.Publication;return this.connect(function(){this.info("Client ? queueing published message to ?: ?",this._0,a,b),this._9({channel:a,data:b,clientId:this._0},function(a){a.successful?c.setDeferredStatus("succeeded"):c.setDeferredStatus("failed",Faye.Error.parse(a.error))},this)},this),c},receiveMessage:function(a){this.pipeThroughExtensions("incoming",a,function(a){if(!a)return;a.advice&&this._F(a.advice);var b=this._q[a.id];b&&(delete this._q[a.id],b[0].call(b[1],a)),this._G(a)},this)},_z:function(a){Faye.Transport.get(this,a,function(a){this._a=a,this._a.cookies=this._E,this._a.headers=this._y,a.bind("down",function(){if(this._c!==undefined&&!this._c)return;this._c=!1,this.trigger("transport:down")},this),a.bind("up",function(){if(this._c!==undefined&&this._c)return;this._c=!0,this.trigger("transport:up")},this)},this)},_9:function(a,b,c){a.id=this._H(),b&&(this._q[a.id]=[b,c]),this.pipeThroughExtensions("outgoing",a,function(a){if(!a)return;this._a.send(a,this._8.timeout/1e3)},this)},_H:function(){return this._e+=1,this._e>=Math.pow(2,32)&&(this._e=0),this._e.toString(36)},_F:function(a){Faye.extend(this._8,a),this._8.reconnect===this.HANDSHAKE&&this._1!==this.DISCONNECTED&&(this._1=this.UNCONNECTED,this._0=null,this._A())},_G:function(a){if(!a.channel||a.data===undefined)return;this.info("Client ? calling listeners for ? with ?",this._0,a.channel,a.data),this._2.distributeMessage(a)},_I:function(){if(!this._r)return;this._r=null,this.info("Closed connection for ?",this._0)},_A:function(){this._I();var a=this;Faye.ENV.setTimeout(function(){a.connect()},this._8.interval)}}),Faye.extend(Faye.Client.prototype,Faye.Deferrable),Faye.extend(Faye.Client.prototype,Faye.Publisher),Faye.extend(Faye.Client.prototype,Faye.Logging),Faye.extend(Faye.Client.prototype,Faye.Extensible),Faye.Transport=Faye.extend(Faye.Class({MAX_DELAY:0,batching:!0,initialize:function(a,b){this.debug("Created new ? transport for ?",this.connectionType,b),this._7=a,this._b=b,this._f=[]},close:function(){},send:function(a,b){this.debug("Client ? sending message to ?: ?",this._7._0,this._b,a);if(!this.batching)return this.request([a],b);this._f.push(a),this._J=b;if(a.channel===Faye.Channel.HANDSHAKE)return this.flush();a.channel===Faye.Channel.CONNECT&&(this._s=a),this.addTimeout("publish",this.MAX_DELAY,this.flush,this)},flush:function(){this.removeTimeout("publish"),this._f.length>1&&this._s&&(this._s.advice={timeout:0}),this.request(this._f,this._J),this._s=null,this._f=[]},receive:function(a){this.debug("Client ? received from ?: ?",this._7._0,this._b,a);for(var b=0,c=a.length;b<c;b++)this._7.receiveMessage(a[b])},retry:function(a,b){var c=!1,d=this._7.retry*1e3,e=this;return function(){if(c)return;c=!0,Faye.ENV.setTimeout(function(){e.request(a,b)},d)}}}),{get:function(a,b,c,d){var e=a.endpoint;b===undefined&&(b=this.supportedConnectionTypes()),Faye.asyncEach(this._t,function(f,l){var m=f[0],n=f[1];if(Faye.indexOf(b,m)<0)return l();n.isUsable(e,function(b){b?c.call(d,new n(a,e)):l()})},function(){throw new Error("Could not find a usable connection type for "+e)})},register:function(a,b){this._t.push([a,b]),b.prototype.connectionType=a},_t:[],supportedConnectionTypes:function(){return Faye.map(this._t,function(a){return a[0]})}}),Faye.extend(Faye.Transport.prototype,Faye.Logging),Faye.extend(Faye.Transport.prototype,Faye.Publisher),Faye.extend(Faye.Transport.prototype,Faye.Timeouts),Faye.Event={_g:[],on:function(a,b,c,d){var e=function(){c.call(d)};a.addEventListener?a.addEventListener(b,e,!1):a.attachEvent("on"+b,e),this._g.push({_h:a,_u:b,_m:c,_n:d,_B:e})},detach:function(a,b,c,d){var e=this._g.length,f;while(e--){f=this._g[e];if(a&&a!==f._h||b&&b!==f._u||c&&c!==f._m||d&&d!==f._n)continue;f._h.removeEventListener?f._h.removeEventListener(f._u,f._B,!1):f._h.detachEvent("on"+f._u,f._B),this._g.splice(e,1),f=null}}},Faye.Event.on(Faye.ENV,"unload",Faye.Event.detach,Faye.Event),Faye.URI=Faye.extend(Faye.Class({queryString:function(){var a=[];for(var b in this.params){if(!this.params.hasOwnProperty(b))continue;a.push(encodeURIComponent(b)+"="+encodeURIComponent(this.params[b]))}return a.join("&")},isLocal:function(){var a=Faye.URI.parse(Faye.ENV.location.href),b=a.hostname!==this.hostname||a.port!==this.port||a.protocol!==this.protocol;return!b},toURL:function(){var a=this.queryString();return this.protocol+this.hostname+":"+this.port+this.pathname+(a?"?"+a:"")}}),{parse:function(a,b){if(typeof a!="string")return a;var c=new this,d=function(b,d){a=a.replace(d,function(a){return a&&(c[b]=a),""})};d("protocol",/^https?\:\/+/),d("hostname",/^[^\/\:]+/),d("port",/^:[0-9]+/),Faye.extend(c,{protocol:Faye.ENV.location.protocol+"//",hostname:Faye.ENV.location.hostname,port:Faye.ENV.location.port},!1),c.port||(c.port=c.protocol==="https://"?"443":"80"),c.port=c.port.replace(/\D/g,"");var e=a.split("?"),f=e.shift(),g=e.join("?"),h=g?g.split("&"):[],i=h.length,j={};while(i--)e=h[i].split("="),j[decodeURIComponent(e[0]||"")]=decodeURIComponent(e[1]||"");return typeof b=="object"&&Faye.extend(j,b),c.pathname=f,c.params=j,c}}),this.JSON||(JSON={}),function(){function k(a){return a<10?"0"+a:a}function r(a){return n.lastIndex=0,n.test(a)?'"'+a.replace(n,function(a){var b=s[a];return typeof b=="string"?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'}function q(a,b){var c,d,e,f,g=l,h,i=b[a];i&&typeof i=="object"&&typeof i.toJSON=="function"&&(i=i.toJSON(a)),typeof o=="function"&&(i=o.call(b,a,i));switch(typeof i){case"string":return r(i);case"number":return isFinite(i)?String(i):"null";case"boolean":case"null":return String(i);case"object":if(!i)return"null";l+=p,h=[];if(Object.prototype.toString.apply(i)==="[object Array]"){f=i.length;for(c=0;c<f;c+=1)h[c]=q(c,i)||"null";return e=h.length===0?"[]":l?"[\n"+l+h.join(",\n"+l)+"\n"+g+"]":"["+h.join(",")+"]",l=g,e}if(o&&typeof o=="object"){f=o.length;for(c=0;c<f;c+=1)d=o[c],typeof d=="string"&&(e=q(d,i),e&&h.push(r(d)+(l?": ":":")+e))}else for(d in i)Object.hasOwnProperty.call(i,d)&&(e=q(d,i),e&&h.push(r(d)+(l?": ":":")+e));return e=h.length===0?"{}":l?"{\n"+l+h.join(",\n"+l)+"\n"+g+"}":"{"+h.join(",")+"}",l=g,e}}typeof Date.prototype.toJSON!="function"&&(Date.prototype.toJSON=function(a){return this.getUTCFullYear()+"-"+k(this.getUTCMonth()+1)+"-"+k(this.getUTCDate())+"T"+k(this.getUTCHours())+":"+k(this.getUTCMinutes())+":"+k(this.getUTCSeconds())+"Z"},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(a){return this.valueOf()});var m=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,n=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,l,p,s={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},o;Faye.stringify=function(a,b,c){var d;l="",p="";if(typeof c=="number")for(d=0;d<c;d+=1)p+=" ";else typeof c=="string"&&(p=c);o=b;if(!b||typeof b=="function"||typeof b=="object"&&typeof b.length=="number")return q("",{"":a});throw new Error("JSON.stringify")},typeof JSON.stringify!="function"&&(JSON.stringify=Faye.stringify),typeof JSON.parse!="function"&&(JSON.parse=function(g,j){function h(a,b){var c,d,e=a[b];if(e&&typeof e=="object")for(c in e)Object.hasOwnProperty.call(e,c)&&(d=h(e,c),d!==undefined?e[c]=d:delete e[c]);return j.call(a,b,e)}var i;m.lastIndex=0,m.test(g)&&(g=g.replace(m,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)}));if(/^[\],:{}\s]*$/.test(g.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return i=eval("("+g+")"),typeof j=="function"?h({"":i},""):i;throw new SyntaxError("JSON.parse")})}(),Faye.Transport.WebSocket=Faye.extend(Faye.Class(Faye.Transport,{UNCONNECTED:1,CONNECTING:2,CONNECTED:3,batching:!1,request:function(a,b){this._i=this._i||{};for(var c=0,d=a.length;c<d;c++)this._i[a[c].id]=a[c];this.withSocket(function(b){b.send(Faye.toJSON(a))})},withSocket:function(a,b){this.callback(a,b),this.connect()},close:function(){if(this._C)return;this._C=!0,this._4&&this._4.close()},connect:function(){if(this._C)return;this._1=this._1||this.UNCONNECTED;if(this._1!==this.UNCONNECTED)return;this._1=this.CONNECTING;var a=Faye.Transport.WebSocket.getClass();this._4=new a(Faye.Transport.WebSocket.getSocketUrl(this._b));var b=this;this._4.onopen=function(){b._1=b.CONNECTED,b.setDeferredStatus("succeeded",b._4),b.trigger("up")},this._4.onmessage=function(a){var c=[].concat(JSON.parse(a.data));for(var d=0,e=c.length;d<e;d++)delete b._i[c[d].id];b.receive(c)},this._4.onclose=function(){var a=b._1===b.CONNECTED;b.setDeferredStatus("deferred"),b._1=b.UNCONNECTED,delete b._4;if(a)return b.resend();var c=b._7.retry*1e3;Faye.ENV.setTimeout(function(){b.connect()},c),b.trigger("down")}},resend:function(){var a=Faye.map(this._i,function(a,b){return b});this.request(a)}}),{WEBSOCKET_TIMEOUT:1e3,getSocketUrl:function(a){return Faye.URI&&(a=Faye.URI.parse(a).toURL()),a.replace(/^http(s?):/ig,"ws$1:")},getClass:function(){return Faye.WebSocket&&Faye.WebSocket.Client||Faye.ENV.WebSocket||Faye.ENV.MozWebSocket},isUsable:function(a,b,c){var d=this.getClass();if(!d)return b.call(c,!1);var e=!1,f=!1,g=this.getSocketUrl(a),h=new d(g);h.onopen=function(){e=!0,h.close(),b.call(c,!0),f=!0,h=null};var i=function(){!f&&!e&&b.call(c,!1),f=!0};h.onclose=h.onerror=i,Faye.ENV.setTimeout(i,this.WEBSOCKET_TIMEOUT)}}),Faye.extend(Faye.Transport.WebSocket.prototype,Faye.Deferrable),Faye.Transport.register("websocket",Faye.Transport.WebSocket),Faye.Transport.EventSource=Faye.extend(Faye.Class(Faye.Transport,{initialize:function(a,b){Faye.Transport.prototype.initialize.call(this,a,b),this._K=new Faye.Transport.XHR(a,b);var c=new EventSource(b+"/"+a.getClientId()),d=this;c.onmessage=function(a){d.receive(JSON.parse(a.data))},this._4=c},request:function(a,b){this._K.request(a,b)},close:function(){this._4.close()}}),{isUsable:function(a,b,c){Faye.Transport.XHR.isUsable(a,function(a){b.call(c,a&&Faye.ENV.EventSource)})}}),Faye.Transport.register("eventsource",Faye.Transport.EventSource),Faye.Transport.XHR=Faye.extend(Faye.Class(Faye.Transport,{request:function(a,b){var c=this.retry(a,b),d=Faye.URI.parse(this._b).pathname,e=this,f=Faye.ENV.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):new XMLHttpRequest;f.open("POST",d,!0),f.setRequestHeader("Content-Type","application/json"),f.setRequestHeader("X-Requested-With","XMLHttpRequest");var g=this.headers;for(var h in g){if(!g.hasOwnProperty(h))continue;f.setRequestHeader(h,g[h])}var i=function(){f.abort()};Faye.Event.on(Faye.ENV,"beforeunload",i);var j=function(){Faye.Event.detach(Faye.ENV,"beforeunload",i),f.onreadystatechange=function(){},f=null};f.onreadystatechange=function(){if(f.readyState!==4)return;var a=null,b=f.status,d=b>=200&&b<300||b===304||b===1223;if(!d)return j(),c(),e.trigger("down");try{a=JSON.parse(f.responseText)}catch(g){}j(),a?(e.receive(a),e.trigger("up")):(c(),e.trigger("down"))},f.send(Faye.toJSON(a))}}),{isUsable:function(a,b,c){b.call(c,Faye.URI.parse(a).isLocal())}}),Faye.Transport.register("long-polling",Faye.Transport.XHR),Faye.Transport.CORS=Faye.extend(Faye.Class(Faye.Transport,{request:function(a,b){var c=Faye.ENV.XDomainRequest?XDomainRequest:XMLHttpRequest,d=new c,e=this.retry(a,b),f=this;d.open("POST",this._b,!0);var g=function(){return d?(d.onload=d.onerror=d.ontimeout=d.onprogress=null,d=null,Faye.ENV.clearTimeout(i),!0):!1};d.onload=function(){var a=null;try{a=JSON.parse(d.responseText)}catch(b){}g(),a?(f.receive(a),f.trigger("up")):(e(),f.trigger("down"))};var h=function(){g(),e(),f.trigger("down")},i=Faye.ENV.setTimeout(h,1500*b);d.onerror=h,d.ontimeout=h,d.onprogress=function(){},d.send("message="+encodeURIComponent(Faye.toJSON(a)))}}),{isUsable:function(a,b,c){if(Faye.URI.parse(a).isLocal())return b.call(c,!1);if(Faye.ENV.XDomainRequest)return b.call(c,!0);if(Faye.ENV.XMLHttpRequest){var d=new Faye.ENV.XMLHttpRequest;return b.call(c,d.withCredentials!==undefined)}return b.call(c,!1)}}),Faye.Transport.register("cross-origin-long-polling",Faye.Transport.CORS),Faye.Transport.JSONP=Faye.extend(Faye.Class(Faye.Transport,{request:function(a,b){var c={message:Faye.toJSON(a)},d=document.getElementsByTagName("head")[0],e=document.createElement("script"),f=Faye.Transport.JSONP.getCallbackName(),g=Faye.URI.parse(this._b,c),h=this.retry(a,b),i=this;Faye.ENV[f]=function(a){k(),i.receive(a),i.trigger("up")};var j=Faye.ENV.setTimeout(function(){k(),h(),i.trigger("down")},1500*b),k=function(){if(!Faye.ENV[f])return!1;Faye.ENV[f]=undefined;try{delete Faye.ENV[f]}catch(a){}return Faye.ENV.clearTimeout(j),e.parentNode.removeChild(e),!0};g.params.jsonp=f,e.type="text/javascript",e.src=g.toURL(),d.appendChild(e)}}),{_D:0,getCallbackName:function(){return this._D+=1,"__jsonp"+this._D+"__"},isUsable:function(a,b,c){b.call(c,!0)}}),Faye.Transport.register("callback-polling",Faye.Transport.JSONP);