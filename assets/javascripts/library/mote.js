var mote=typeof module!="undefined"&&module.exports||{};(function(a){function c(a){return a.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")}function d(a){return JSON.stringify(a)}function e(a){this.raw=a,this.str=a,this.pos=0}function f(a){var b=new g;return b.parse(a)}function g(){this.tokens=[],this.tokenCollector=this.tokens,this.sections=[],this.otag="{{",this.ctag="}}",this.compileRegexen()}function h(){this.partialIndex=1,this.partials={},this.sectionIndex=1,this.sections={},this.lookupIndex=1,this.lookups={}}function j(a,b,c){this.obj=a,this.tail=b,this.root=c||a}var b=Array.isArray||function(a){return Object.prototype.toString.call(a)=="[object Array]"};e.prototype.eos=function(){return!this.str},e.prototype.startOfLine=function(){return!this.pos||this.raw.charAt(this.pos-1)==="\n"},e.prototype.scan=function(a){var b=this.str.match(a);return!b||b.index>0?null:(this.str=this.str.substring(b[0].length),this.pos+=b[0].length,b[0])},e.prototype.scanUntil=function(a){var b,c=this.str.search(a);switch(c){case-1:b=this.str,this.pos+=this.str.length,this.str="";break;case 0:b=null;break;default:b=this.str.substring(0,c),this.str=this.str.substring(c),this.pos+=c}return b},g.prototype.compileRegexen=function(){this.re.opentag=new RegExp("(?:([ \\t]*))?"+c(this.otag)),this.re.closetag=new RegExp("[\\}!=]?"+c(this.ctag))},g.prototype.re={newline:/\r?\n/,whitespace:/[ \t]*/,trailing:/[ \t]*(?:\r?\n|$)/,tagtype:/\{|&|#|\^|\/|>|=|!|\?/,allowed:/[\w\$\.]+/,lines:/(.*)(\r?\n)?/g},g.prototype.standalone=function(a){return a&&a!=="{"&&a!=="&"},g.prototype.parse=function(a,b){b=b||{},b.otag&&b.ctag&&(this.otag=b.otag,this.ctag=b.ctag,this.compileRegexen()),this.addLineStart(),this.scanner=new e(a);while(!this.scanner.eos())this.scanTags();return this.clean(this.tokens)},g.prototype.clean=function(a){return a.length>1&&a[1].type==="sol"&&a.shift(),a},g.prototype.scanTags=function(){var a,b,c,e,f,g=!1;this.scanText(),f=this.scanner.startOfLine(),f&&!this.scanner.eos()&&this.addLineStart();if(!(a=this.scanner.scan(this.re.opentag)))return;b=this.re.whitespace.exec(a),b=b&&b[0],c=this.scanner.scan(this.re.tagtype),c=c&&c[0],this.scanner.scan(this.re.whitespace),c==="!"||c==="="?e=this.scanner.scanUntil(this.re.closetag):(e=this.scanner.scan(this.re.allowed),e.indexOf(".")>0?e=d(e.split(".")):e=d(e)),this.scanner.scan(this.re.whitespace);if(!this.scanner.scan(this.re.closetag))throw new Error("Unclosed tag");f&&this.standalone(c)&&this.scanner.scan(this.re.trailing)!==null&&(g=!0),g||(this.addText(b),b=""),this.addTag(c,e,b)},g.prototype.scanText=function(a){var b=this.scanner.scanUntil(this.re.opentag);this.addText(b)},g.prototype.addLineStart=function(){this.tokenCollector.push({type:"sol"})},g.prototype.addText=function(a){var b,c,d;if(!a)return;d=a.match(this.re.lines),d.pop();for(b=0,c=d.length;b<c;b++)this.text(d[b]),b<c-1&&this.addLineStart()},g.prototype.addTag=function(a,b,c){switch(a){case"=":this.setDelimiters(b);break;case"!":break;case"#":this.openSection(b,{sectionType:"section"});break;case"^":this.openSection(b,{sectionType:"inverted"});break;case"?":this.openSection(b,{sectionType:"exists"});break;case"/":this.closeSection(b);break;case">":this.partial(b,c);break;case"{":case"&":this.variable(b,{escape:!1});break;default:this.variable(b,{escape:!0})}},g.prototype.setDelimiters=function(a){var b=a.split(/\s+/);this.otag=b[0],this.ctag=b[1],this.compileRegexen()},g.prototype.openSection=function(a,b){var c={type:b.sectionType,key:a,tokens:[]};this.tokenCollector.push(c),this.sections.push(c),this.tokenCollector=c.tokens},g.prototype.closeSection=function(a,b){var c,d;if(this.sections.length===0)throw new Error("Unopened section: "+a);c=this.sections.pop();if(c.key!==a)throw new Error("Unclosed section: "+c.key);d=this.sections.length-1,this.tokenCollector=this.sections.length?this.sections[d].tokens:this.tokens},g.prototype.partial=function(a,b){this.tokenCollector.push({type:"partial",key:a,indent:b})},g.prototype.variable=function(a,b){this.tokenCollector.push({type:"variable",key:a,escape:b.escape})},g.prototype.text=function(a){var b=this.tokenCollector.length-1;b>=0&&this.tokenCollector[b].type==="text"?this.tokenCollector[b].value+=a:this.tokenCollector.push({type:"text",value:a})},h.prototype.compile=function(a){var b,c=f(a);return b="  return "+this.compileTokens(c).substring(3)+";",b=this.extractLookups(b,"  ")+'  i = i || "";\n'+this.compilePartials()+this.compileSections()+b,new Function("c, w, i",b)},h.prototype.compileTokens=function(a){var b=0,c=a.length,d="";for(;b<c;b++)d+=this.compileToken(a[b]);return d},h.prototype.compileSections=function(){var a,b="";for(a in this.sections)b+="  function section"+a+"(c, w, i) {\n"+this.extractLookups(this.sections[a],"    ")+"    return "+this.sections[a].substring(3)+";\n"+"  }\n";return b},h.prototype.compilePartials=function(){var a,b="";for(a in this.partials)b+="  var partial"+a+" = w.loadTemplate("+this.partials[a]+");\n";return b},h.prototype.compileToken=function(a){return this["compile_"+a.type](a)},h.prototype.compileLookup=function(a){var b="lookup"+this.lookupIndex++,c="c.lookup("+a+");\n";return this.lookups[b]=c,b},h.prototype.extractLookups=function(a,b){var c,d,e,a,f={},g="",h=/lookup(\d+)/g,i=a.match(h);if(i)for(c=0,d=i.length;c<d;c++)e=i[c],a=this.lookups[e],g+=b+"var "+e+" = "+(f[a]||this.lookups[e]),f[a]=e+";\n";return g},h.prototype.compile_text=function(a){return" + "+d(a.value)+""},h.prototype.compile_sol=function(a){return" + i"},h.prototype.compile_variable=function(a){var b=this.compileLookup(a.key);return" + w.variable("+b+", c, "+a.escape+")"},h.prototype.compile_partial=function(a){var b=this.partialIndex++;return this.partials[b]=a.key," + partial"+b+"(c, "+d(a.indent)+")"},h.prototype.compileSectionTokens=function(a,b){var c=this.sectionIndex++,d=this.compileLookup(a.key);return this.sections[c]=this.compileTokens(a.tokens)," + w."+b+"("+d+", c, section"+c+", i)"},h.prototype.compile_section=function(a){return this.compileSectionTokens(a,"section")},h.prototype.compile_inverted=function(a){return this.compileSectionTokens(a,"inverted")},h.prototype.compile_exists=function(a){return this.compileSectionTokens(a,"exists")};var i={};i.noop=function(){return""},i.isArray=b,i.escapeRE=/[&"<>]/g,i.escaper=function(a){switch(a){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";default:return a}},i.escapeHTML=function(a){return this.escapeRE.test(a)?a.replace(this.escapeRE,this.escaper):a},i.cache={},i.clearCache=function(){this.cache={}},i.loadTemplate=function(a){return this.cache[a]||this.noop},i.compile=function(a){var b=new h,c=b.compile(a),d=this;return function(a,b){return c(j.wrap(a),d,b)}},i.compilePartial=function(a,b){return this.cache[a]=this.compile(b),this.cache[a]},i.variable=function(a,b,c){return typeof a=="function"&&(a=a.call(b.root)),a=a!=null?""+a:"",c?this.escapeHTML(a):a},i.partial=function(a,b,c){return this.loadTemplate(a)(b,c)},i.section=function(a,b,c,d){var e,f,g,h;if(this.isArray(a)){e="",g=a.length;for(f=0;f<g;f++)e+=c(b.push(a[f]),this,d);return e}return typeof a=="function"?(h=this,a.call(b.root,function(){return c(b,h,d)})):a?c(b.push(a),this,d):""},i.inverted=function(a,b,c,d){return!a||this.isArray(a)&&a.length===0?c(b,this,d):""},i.exists=function(a,b,c,d){return!a||this.isArray(a)&&a.length===0?"":c(b.push(a),this,d)},j.prototype.isArray=b,j.wrap=function(a){return a instanceof j?a:new j(a)},j.prototype.push=function(a){return new j(a,this,this.root)},j.prototype.lookup=function(a){var b,c=this;while(c){b=this.isArray(a)?this.getPath(c.obj,a):a==="."?c.obj:c.obj[a];if(b!=null)return b;c=c.tail}return undefined},j.prototype.getPath=function(a,b){var c=0,d=b.length,e=a;for(;c<d;c++){if(e==null)return undefined;e=e[b[c]]}return e},a.cache=i.cache,a.clearCache=function(){i.clearCache()},a.compile=function(a){return i.compile(a)},a.compilePartial=function(a,b){return i.compilePartial(a,b)},a.Writer=i,a.Parser=g,a.Compiler=h,a.VERSION="0.2.0"})(mote);